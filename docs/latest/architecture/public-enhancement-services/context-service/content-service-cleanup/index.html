<!doctype html>
<html class="docs-version-1.3.0" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Linkis Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Linkis Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache Linkis" href="/opensearch.xml"><title data-react-helmet="true">CS Cleanup Interface Features | Apache Linkis</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://linkis.incubator.apache.org/docs/latest/architecture/public-enhancement-services/context-service/content-service-cleanup"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="1.3.0"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-1.3.0"><meta data-react-helmet="true" property="og:title" content="CS Cleanup Interface Features | Apache Linkis"><meta data-react-helmet="true" name="description" content="1. Functional requirements"><meta data-react-helmet="true" property="og:description" content="1. Functional requirements"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://linkis.incubator.apache.org/docs/latest/architecture/public-enhancement-services/context-service/content-service-cleanup"><link data-react-helmet="true" rel="alternate" href="https://linkis.incubator.apache.org/docs/latest/architecture/public-enhancement-services/context-service/content-service-cleanup" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://linkis.incubator.apache.org/zh-CN/docs/latest/architecture/public-enhancement-services/context-service/content-service-cleanup" hreflang="zh-CN"><link data-react-helmet="true" rel="alternate" href="https://linkis.incubator.apache.org/docs/latest/architecture/public-enhancement-services/context-service/content-service-cleanup" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://AE29KQB3IA-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.43be7c54.css">
<link rel="preload" href="/assets/js/runtime~main.8c2fcd23.js" as="script">
<link rel="preload" href="/assets/js/main.ffdafd4c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Apache Linkis Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo.png" alt="Apache Linkis Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Apache Linkis(Incubating)</b></a><a class="navbar__item navbar__link" href="/download/main">Download</a><a class="navbar__item navbar__link" href="/community/how-to-subscribe">Community</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/team">Team</a><a class="navbar__item navbar__link" href="/user">Users</a><a class="navbar__item navbar__link" href="/faq/main">FAQ</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link">Doc</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/latest/introduction">1.3.0</a></li><li><a class="dropdown__link" href="/docs/1.2.0/introduction">1.2.0</a></li><li><a class="dropdown__link" href="/docs/1.1.3/introduction">1.1.3</a></li><li><a class="dropdown__link" href="/docs/1.1.2/introduction">1.1.2</a></li><li><a class="dropdown__link" href="/docs/1.1.1/introduction">1.1.1</a></li><li><a class="dropdown__link" href="/docs/1.1.0/introduction">1.1.0</a></li><li><a class="dropdown__link" href="/docs/1.0.3/introduction">1.0.3</a></li><li><a class="dropdown__link" href="/docs/1.0.2/introduction">1.0.2</a></li><li><a class="dropdown__link" href="/docs/0.11.0/introduction">0.11.0</a></li><li><a class="dropdown__link" href="/docs/1.3.1/introduction">Next(1.3.1)</a></li><li><a class="dropdown__link" href="/versions">All Version</a></li></ul></div><a href="https://github.com/apache/incubator-linkis" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg t="1631348384596" class="iconLanguage_EbrZ" viewBox="0 0 1024 1024" version="1.1" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/docs/latest/architecture/public-enhancement-services/context-service/content-service-cleanup" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh-CN/docs/latest/architecture/public-enhancement-services/context-service/content-service-cleanup" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">简体中文</a></li></ul></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button class="clean-btn backToTopButton_i9tI" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/latest/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/latest/release">Version Overview</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Deployment</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">User Guide</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Engine Usage</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">API</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Table Structure</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Architecture</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/architecture/overview">Overview</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/architecture/difference-between-1.0-and-0.x">Difference Between 1.0 &amp; 0.x</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Commons</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Computation Governance Services</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Public Enhancement Services</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/architecture/public-enhancement-services/overview">Overview</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/architecture/public-enhancement-services/public-service">Public Service</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">BML</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Context Service</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/architecture/public-enhancement-services/context-service/overview">Overview</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/architecture/public-enhancement-services/context-service/context-service">CS Architecture</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/architecture/public-enhancement-services/context-service/context-service-client">CS Client Design</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/architecture/public-enhancement-services/context-service/context-service-highavailable">CS HA Design</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/architecture/public-enhancement-services/context-service/context-service-listener">CS Listener Architecture</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/architecture/public-enhancement-services/context-service/context-service-persistence">CS Persistence Architecture</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/architecture/public-enhancement-services/context-service/context-service-search">CS Search Architecture</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/architecture/public-enhancement-services/context-service/context-service-cache">CS Cache Architecture</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/latest/architecture/public-enhancement-services/context-service/content-service-cleanup">CS Cleanup Interface Features</a></li></ul></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/architecture/public-enhancement-services/datasource-manager">Data Source Management Service Architecture</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/architecture/public-enhancement-services/metadata-manager">Data Source Management Service Architecture</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Microservice Governance Services</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Development</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Upgrade Guide</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tuning And Troubleshooting</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><span class="theme-doc-version-badge badge badge--secondary">Version: 1.3.0</span><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>CS Cleanup Interface Features</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="1-functional-requirements"></a>1. Functional requirements<a class="hash-link" href="#1-functional-requirements" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="11-background"></a>1.1 Background<a class="hash-link" href="#11-background" title="Direct link to heading">#</a></h3><p>Before version 1.1.3, the ContextService unified context service lacked a cleaning mechanism, and lacked the creation time, update time fields, and batch cleaning interfaces.
In the case of long-term accumulation, millions of data may appear, affecting query efficiency.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="12-goals"></a>1.2 Goals<a class="hash-link" href="#12-goals" title="Direct link to heading">#</a></h3><ul><li>Modify 1ContextService<code>underlying library table, add creation time, modification time, last access time fields, complete the update time of</code>ContextID<code>and</code>ContextMap` related data into the database</li><li>Add <code>restful</code> interface for cleaning and cleaning, support batch and retail cleaning interface according to time range and id list</li><li>Add the corresponding <code>java sdk</code> interface of <code>cs-client</code></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="2-overall-design"></a>2. Overall Design<a class="hash-link" href="#2-overall-design" title="Direct link to heading">#</a></h2><p>This requirement involves <code>cs-client</code>, <code>cs-persistence</code> and <code>cs-server</code> modules under <code>ContextService</code>.
Add 3 fields of the existing table in the <code>cs-persistence</code> module; add 3 <code>restful</code> interfaces in the <code>cs-server</code> module, and add 3 <code>sdk api</code> in the <code>cs-client</code> module.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="21-technical-architecture"></a>2.1 Technical Architecture<a class="hash-link" href="#21-technical-architecture" title="Direct link to heading">#</a></h3><p>For the overall architecture of ContextService, please refer to the existing document: <a href="/docs/latest/architecture/public-enhancement-services/context-service/overview">ContextService Architecture Document</a></p><p>The access relationship of each module of ContestService is shown in the following figure
<img alt="linkis-contextservice-clean-01.png" src="/assets/images/linkis-contextservice-clean-01-6f4aa01a1d246c06114ec7a26452399f.png"></p><p>Table changes are made in the <code>cs-persistence</code> module. This change involves 5 tables <code>context_id, context_map, context_id_listener, context_key_listener, context_history</code>, all of which need to add 3 fields <code>create_time, update_time, access_time</code>. The <code>context_id and context_map</code> tables are enabled, and the other three tables are not enabled. <code>create_time</code> adds the time before the persistence module performs the insert operation. <code>update_time</code> and <code>access_time</code> are actively called by the upstream interface. In the update interface, <code>update_time</code> and <code>access_time</code> are mutually exclusive updates, that is, when <code>access_time</code> exists (not null), <code>update_time</code> will not be updated, otherwise update_time will be updated .</p><p>The <code>update_time</code> field is updated in the cs-cache module, the ADD message is detected when a new <code>context_id</code> is loaded from the db, and the <code>access_time</code> is synchronized to the db at this time.
Only the <code>create_time, update_time, access_time</code> of the <code>context_id</code> table are recorded in the table. Subsequent search cleaning is also performed from the context_id table.</p><p>Add 3 cleanup related interfaces: <code>searchContextIDByTime, clearAllContextByID, clearAllContextByTime</code></p><ul><li><code>searchContextIDByTime</code> searches according to 3 time ranges and returns a list of contextIDs</li><li><code>clearAllContextByID</code> clears the content of the context_map table and context_id table corresponding to the ID in the input contextID list</li><li><code>clearAllContextByTime</code> searches according to 3 time ranges, and clears all the contents of the context_map table and context_id table corresponding to the searched contextID</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="22-business-architecture"></a>2.2 Business Architecture<a class="hash-link" href="#22-business-architecture" title="Direct link to heading">#</a></h3><p>This feature is to add related interfaces for batch query and cleanup to the ContextService service, and to add fields such as the update time of the underlying data table, so as to clean up expired data according to the access situation. The function points involve the modules as shown in the table below.</p><table><thead><tr><th align="left">First-level module</th><th align="left">Second-level module</th><th align="left">Function point</th></tr></thead><tbody><tr><td align="left">linkis-ps-cs</td><td align="left">cs-client</td><td align="left">Added batch cleaning interface related java sdk api interface</td></tr><tr><td align="left">Linkis-ps-cs</td><td align="left">cs-server</td><td align="left">Added restful interface related to batch cleaning interface</td></tr><tr><td align="left">linkis-ps-cs</td><td align="left">cs-persistence</td><td align="left">Add 3 time-related fields of the underlying table</td></tr></tbody></table><p>##3. Module Design
###Main execution process</p><ul><li>Create ContextID. When the user creates the ContextID, the create_time will be recorded, and this field will not be updated later</li><li>Update ContextID. When the user updates the ContextID, the update_time field is updated. Note that if the update is from the cache at this time, the access_time field will not be updated; if it is loaded from the db to the cache and then updated with the new contextID, the access_time will be updated first, and then the new update_time will be updated separately.</li><li>Query ContextID according to time. When the user queries the ContextID of the corresponding time range, only a list of haid strings will be returned. This interface has paging, the default is limited to 5000 pieces of data</li><li>Bulk cleanup of ContextIDs. All contextMap data and contextID data corresponding to the incoming idList will be cleaned up in batches. The maximum number of incoming arrays is 5000</li><li>Query and clear ContextID, first query and then batch clear</li></ul><p>The corresponding timing diagrams above are as follows:
<img alt="linkis-contextservice-clean-02.png" src="/assets/images/linkis-contextservice-clean-02-5cf135c352337570bf058ce5a60104c0.png"></p><p>Two of them require additional attention:
①The restful api in the cs-server service will encapsulate the request as a Job and submit it to the queue and block waiting for the result. The operation type of CLEAR is newly defined to facilitate matching to the cleanup related interface.
② To process the Service service of the Job in ①, the name needs to be defined as not including the ContextID to avoid the dynamic proxy conversion of the HighAvailable module. This conversion is only for the interface with only one ContextID in the request, and it is meaningless and affects the batch cleanup and batch query interface. performance.</p><p>##4. Data structure</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># The main involved context_id table structure is as follows, adding create_time, update_time, expire_time fields</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE TABLE `linkis_ps_cs_context_id` (</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  `id` int(11) NOT NULL AUTO_INCREMENT,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  `user` varchar(32) DEFAULT NULL,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  `application` varchar(32) DEFAULT NULL,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  `source` varchar(255) DEFAULT NULL,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  `expire_type` varchar(32) DEFAULT NULL,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  `expire_time` datetime DEFAULT NULL,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  `instance` varchar(128) DEFAULT NULL,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  `backup_instance` varchar(255) DEFAULT NULL,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;update unix timestamp&#x27;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;create time&#x27;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  `access_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;last access time&#x27;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  PRIMARY KEY (`id`),</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  KEY `instance` (`instance`(128)),</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  KEY `backup_instance` (`backup_instance`(191)),</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  KEY `instance_2` (`instance`(128), `backup_instance`(128))</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>##5. Interface Design
###5.1 Restful interface</p><p>1 Query ID interface <code>searchContextIDByTime</code></p><p>①Interface name
GET <code>/api/rest_j/v1/contextservice/searchContextIDByTime</code></p><p>②Input parameters</p><table><thead><tr><th>Parameter name</th><th>Parameter description</th><th>Request type</th><th>Required</th><th>Data type</th><th>schema</th></tr></thead><tbody><tr><td>accessTimeEnd</td><td>Access end time</td><td>query</td><td>false</td><td>string</td><td></td></tr><tr><td>accessTimeStart</td><td>Access start time</td><td>query</td><td>false</td><td>string</td><td></td></tr><tr><td>createTimeEnd</td><td>Create end time</td><td>query</td><td>false</td><td>string</td><td></td></tr><tr><td>createTimeStart</td><td>create time</td><td>query</td><td>false</td><td>string</td><td></td></tr><tr><td>pageNow</td><td>page number</td><td>query</td><td>false</td><td>string</td><td></td></tr><tr><td>pageSize</td><td>page size</td><td>query</td><td>false</td><td>string</td><td></td></tr><tr><td>updateTimeEnd</td><td>Update end time</td><td>query</td><td>false</td><td>string</td><td></td></tr><tr><td>updateTimeStart</td><td>Update time</td><td>query</td><td>false</td><td>string</td><td></td></tr></tbody></table><p>③Example of output parameters</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;method&quot;: &quot;/api/contextservice/searchContextIDByTime&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;status&quot;: 0,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;message&quot;: &quot;OK&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;data&quot;: {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;contextIDs&quot;: [</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;8-8--cs_1_devcs_2_dev10493&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;8-8--cs_1_devcs_2_dev10494&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;8-8--cs_1_devcs_2_dev10495&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;8-8--cs_1_devcs_2_dev10496&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;8-8--cs_1_devcs_2_dev10497&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;8-8--cs_2_devcs_2_dev10498&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="2"><li>Clear the specified ID interface clearAllContextByID</li></ol><p>①Interface name <code>POST /api/rest_j/v1/contextservice/clearAllContextByID</code>
② Example of input parameters</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;idList&quot; : [</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;8-8--cs_1_devcs_1_dev2236&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>③Example of output parameters</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;method&quot;: &quot;/api/contextservice/clearAllContextByID&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;status&quot;: 0,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;message&quot;: &quot;OK&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;data&quot;: {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;num&quot;: &quot;1&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="3"><li>Clean up the interface <code>clearAllContextByTime</code> according to the time
①Interface name
POST /api/rest_j/v1/contextservice/clearAllContextByTime
② Example of input parameters
{
&quot;createTimeStart&quot;: &quot;2022-06-01 00:00:00&quot;,
&quot;createTimeEnd&quot;: &quot;2022-06-30 00:00:00&quot;
}
③Example of output parameters</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;method&quot;: &quot;/api/contextservice/clearAllContextByTime&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;status&quot;: 0,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;message&quot;: &quot;OK&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;data&quot;: {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;num&quot;: &quot;1&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>###5.2 JAVA SDK API</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># import pom</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;dependency&gt;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     &lt;groupId&gt;org.apache.linkis&lt;/groupId&gt;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     &lt;artifactId&gt;linkis-cs-client&lt;/artifactId&gt;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     &lt;version&gt;1.1.3&lt;/version&gt;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;/dependency&gt;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Code reference is as follows</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">String createTimeStart = &quot;2022-05-26 22:04:00&quot;;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String createTimeEnd = &quot;2022-06-01 24:00:00&quot;;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ContextClient contextClient = ContextClientFactory.getOrCreateContextClient();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Interface 1 searchHAIDByTime</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;String&gt; idList =</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                contextClient.searchHAIDByTime(</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        createTimeStart, createTimeEnd, null, null, null, null, 0, 0);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for (String id : idList) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            System.out.println(id);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println(&quot;Got &quot; + idList.size() + &quot;ids.&quot;);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (idList.size() &gt; 0) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String id1 = idList.get(0);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            System.out.println(&quot;will clear context of id : &quot; + id1);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Interface 2 batchClearContextByHAID</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;String&gt; tmpList = new ArrayList&lt;&gt;();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        tmpList.add(id1);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        int num = contextClient.batchClearContextByHAID(tmpList);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println(&quot;Succeed to clear &quot; + num + &quot; ids.&quot;);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Interface 3 batchClearContextByTime</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        int num1 =</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                contextClient.batchClearContextByTime(</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        createTimeStart, createTimeEnd, null, null, null, null);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println(&quot;Succeed to clear &quot; + num1 + &quot; ids by time.&quot;);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="6-non-functional-design"></a>6. Non-functional design<a class="hash-link" href="#6-non-functional-design" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="61-security"></a>6.1 Security<a class="hash-link" href="#61-security" title="Direct link to heading">#</a></h3><p>The resultful interface requires login authentication and requires an administrator to operate. The administrator user is configured in the properties file</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="62-performance"></a>6.2 Performance<a class="hash-link" href="#62-performance" title="Direct link to heading">#</a></h3><ul><li>The query ID interface searchContextIDByTime has paging, no performance impact</li><li>Clear the specified ID interface clearAllContextByID to limit the amount of operation data, no performance impact</li><li>The interface clearAllContextByTime is cleared according to the time. If the query time range is too large, the query may time out, but the task will not fail. and the cleanup operation is a single operation and does not affect other queries</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="63-capacity"></a>6.3 Capacity<a class="hash-link" href="#63-capacity" title="Direct link to heading">#</a></h3><p>This requirement provides a time range query and batch cleaning interface, which requires the upper-layer application that uses ContextService to actively clean up data.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="64-high-availability"></a>6.4 High Availability<a class="hash-link" href="#64-high-availability" title="Direct link to heading">#</a></h3><p>The interface reuses the high availability of the ContextService microservice itself.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/docs/latest/tags/feature">Feature</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/apache/incubator-linkis-website/edit/dev/versioned_docs/version-1.3.0/architecture/public-enhancement-services/context-service/content-service-cleanup.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/latest/architecture/public-enhancement-services/context-service/context-service-cache"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« CS Cache Architecture</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/latest/architecture/public-enhancement-services/datasource-manager"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Data Source Management Service Architecture »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-functional-requirements" class="table-of-contents__link">1. Functional requirements</a><ul><li><a href="#11-background" class="table-of-contents__link">1.1 Background</a></li><li><a href="#12-goals" class="table-of-contents__link">1.2 Goals</a></li></ul></li><li><a href="#2-overall-design" class="table-of-contents__link">2. Overall Design</a><ul><li><a href="#21-technical-architecture" class="table-of-contents__link">2.1 Technical Architecture</a></li><li><a href="#22-business-architecture" class="table-of-contents__link">2.2 Business Architecture</a></li></ul></li><li><a href="#6-non-functional-design" class="table-of-contents__link">6. Non-functional design</a><ul><li><a href="#61-security" class="table-of-contents__link">6.1 Security</a></li><li><a href="#62-performance" class="table-of-contents__link">6.2 Performance</a></li><li><a href="#63-capacity" class="table-of-contents__link">6.3 Capacity</a></li><li><a href="#64-high-availability" class="table-of-contents__link">6.4 High Availability</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Linkis</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/latest/introduction">Document</a></li><li class="footer__item"><a class="footer__link-item" href="/faq/main">FAQ</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-linkis/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Releases<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/apache/incubator-linkis" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-linkis/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Issue Tracker<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-linkis/pulls" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Pull Requests<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Subscribe Mailing List</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/community/how-to-subscribe">How to Subscribe</a></li><li class="footer__item"><a href="mailto:dev-subscribe@linkis.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Subscribe Mail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://lists.apache.org/list.html?dev@linkis.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Mail Archive<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div><img style="height:50px" alt="Apache Software Foundation" src="/img/incubator-logo.svg"><p style="color: #999999;  padding: 0 20px 30px;font-weight:400;text-align:left">Apache Linkis is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p><p></p>
             <p style="padding: 0 20px 30px;color: #999999;font-weight: 400;"> Copyright © 2022 The Apache Software Foundation. Licensed under the Apache License, Version 2.0. Apache Linkis, Apache Incubator, Apache, the Apache feather logo, the Apache Linkis logo and the Apache Incubator project logo are trademarks of The Apache Software Foundation.</p>
             <div></div></div></div></div></div></footer></div>
<script src="/assets/js/runtime~main.8c2fcd23.js"></script>
<script src="/assets/js/main.ffdafd4c.js"></script>
</body>
</html>